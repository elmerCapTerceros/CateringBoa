<div class="w-full flex-auto p-6 sm:p-10 bg-gray-50 min-h-screen">

    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <h2 class="text-3xl font-bold tracking-tight text-blue-900">Historial de Compras</h2>
            <p class="text-gray-500">Gestión de entregas parciales y cierres de orden.</p>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
        <form [formGroup]="filterForm" class="flex flex-col md:flex-row gap-4 items-center">
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="w-full md:w-auto">
                <mat-label>Rango de Fechas</mat-label>
                <mat-date-range-input [rangePicker]="picker">
                    <input matStartDate formControlName="fechaInicio" placeholder="Inicio">
                    <input matEndDate formControlName="fechaFin" placeholder="Fin">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-semibold">
            <tr>
                <th class="p-4 text-left">ID Orden</th>
                <th class="p-4 text-left">Proveedor</th>
                <th class="p-4 text-center">Fecha</th>
                <th class="p-4 text-right">Ejecutado</th>
                <th class="p-4 text-center">Estado</th>
                <th class="p-4 text-center">Gestión</th>
                <th class="p-4 text-center w-10"></th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
                @for (orden of listaVisible; track orden.idReal) {
                    <tr class="hover:bg-gray-50 transition-colors cursor-pointer group" (click)="toggleDetalle(orden)">
                        <td class="p-4 font-bold text-blue-800">{{ orden.id }}</td>
                        <td class="p-4 text-gray-700">{{ orden.proveedor }}</td>
                        <td class="p-4 text-center text-gray-500">{{ orden.fecha | date:'dd/MM/yyyy' }}</td>

                        <td class="p-4 text-right">
                            <span class="font-bold text-slate-800">{{ getTotalEjecutado(orden) | currency }}</span>
                        </td>

                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-bold uppercase tracking-wider block w-fit mx-auto"
                                  [ngClass]="{
                                    'bg-green-100 text-green-800': orden.estado === 'Completado',
                                    'bg-blue-100 text-blue-800': orden.estado === 'Parcial',
                                    'bg-orange-100 text-orange-800': orden.estado === 'Pendiente'
                                  }">
                                {{ orden.estado }}
                            </span>
                        </td>

                        <td class="p-4 text-center" (click)="$event.stopPropagation()">
                            @if (orden.estado !== 'Completado' && orden.estado !== 'Cancelado') {
                                <button mat-flat-button color="primary"
                                        class="h-8 text-xs bg-blue-600 text-white shadow-sm hover:bg-blue-700 transition-colors"
                                        (click)="abrirRecepcion(orden, $event)">
                                    <mat-icon class="icon-size-4 mr-1">archive</mat-icon> Recibir
                                </button>
                            }
                        </td>

                        <td class="p-4 text-center">
                            <mat-icon class="text-gray-400 transition-transform duration-200" [class.rotate-180]="orden.expandido">expand_more</mat-icon>
                        </td>
                    </tr>

                    @if (orden.expandido) {
                        <tr class="bg-slate-50">
                            <td colspan="7" class="p-0">
                                <div class="p-6 pl-12 border-b border-gray-200">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Progreso de Entrega</h4>

                                    <table class="w-full text-xs bg-white rounded border border-gray-200">
                                        <thead class="bg-gray-100 text-gray-500">
                                        <tr>
                                            <th class="p-3 text-left">Producto</th>
                                            <th class="p-3 text-center">Pedido</th>
                                            <th class="p-3 text-center">Recibido</th>
                                            <th class="p-3 text-center w-1/3">Avance</th>
                                            <th class="p-3 text-center text-red-500 font-bold">Faltante</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            @for (item of orden.items; track item.nombre) {
                                                <tr class="border-b border-gray-50 last:border-0">
                                                    <td class="p-3 font-medium text-gray-700">{{ item.nombre }}</td>
                                                    <td class="p-3 text-center font-bold">{{ item.cantidad }}</td>
                                                    <td class="p-3 text-center text-green-600 font-bold">{{ item.cantidadRecibida }}</td>
                                                    <td class="p-3 align-middle">
                                                        <div class="flex items-center gap-2">
                                                            <mat-progress-bar mode="determinate" [value]="getProgreso(item)" class="rounded h-2 w-full"></mat-progress-bar>
                                                            <span class="text-[10px] text-gray-400">{{ getProgreso(item) | number:'1.0-0' }}%</span>
                                                        </div>
                                                    </td>
                                                    <td class="p-3 text-center font-bold text-red-500">
                                                        {{ item.cantidad - item.cantidadRecibida }}
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<ng-template #dialogRecepcion>
    <div class="flex flex-col max-h-[90vh]">
        <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
            <div>
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <mat-icon class="text-blue-600">move_to_inbox</mat-icon> Recepción Parcial
                </h2>
                <p class="text-xs text-gray-500">Orden: <span class="font-mono font-bold">{{ ordenSeleccionada?.id }}</span></p>
            </div>
        </div>

        <div class="p-0 overflow-y-auto">
            <div class="bg-blue-50 p-4 text-xs text-blue-800 border-b border-blue-100 flex gap-2 items-center">
                <mat-icon class="icon-size-5">info</mat-icon>
                Ingrese solo la cantidad que llega hoy.
            </div>

            <table class="w-full text-sm text-left">
                <thead class="bg-gray-100 text-gray-500 font-semibold uppercase text-xs">
                <tr>
                    <th class="p-4">Producto</th>
                    <th class="p-4 text-center w-24">Pendiente</th>
                    <th class="p-4 text-center w-32">Ingreso Hoy</th>
                    <th class="p-4 text-right w-32">Costo a Pagar</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    @for (item of ordenSeleccionada?.items; track item.nombre) {
                        @if (item.cantidadRecibida < item.cantidad) {
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-medium text-slate-700">
                                    {{ item.nombre }}
                                </td>
                                <td class="p-4 text-center font-bold text-orange-600 align-middle">
                                    {{ item.cantidad - item.cantidadRecibida }}
                                </td>
                                <td class="p-4 align-middle">
                                    <input type="number" min="0" [max]="item.cantidad - item.cantidadRecibida"
                                           [(ngModel)]="item.ingresoActual" (ngModelChange)="calcularMontoRecepcionActual()"
                                           class="w-full p-2 border border-gray-300 rounded text-center font-bold text-blue-600 focus:ring-2 focus:ring-blue-500">
                                </td>
                                <td class="p-4 text-right align-middle font-bold text-slate-800">
                                    {{ (item.costoUnitario * (item.ingresoActual || 0)) | currency }}
                                </td>
                            </tr>
                        }
                    }
                </tbody>
                <tfoot class="bg-gray-50 border-t border-gray-200">
                <tr>
                    <td colspan="3" class="p-4 text-right font-bold text-gray-600 uppercase text-xs">Total a Pagar</td>
                    <td class="p-4 text-right font-black text-xl text-green-700">
                        {{ montoAPagarEnEstaRecepcion | currency }}
                    </td>
                </tr>
                </tfoot>
            </table>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
            <button mat-stroked-button (click)="dialog.closeAll()">Cancelar</button>
            <button mat-flat-button color="primary" class="bg-green-600 text-white" (click)="confirmarRecepcion()">
                <mat-icon class="mr-2">check</mat-icon> Confirmar Ingreso
            </button>
        </div>
    </div>
</ng-template>
