<div class="w-full flex-auto p-6 sm:p-10 bg-gray-50 min-h-screen">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold tracking-tight text-blue-900">Historial de Compras</h2>
            <p class="text-gray-500">Consulta de Ã³rdenes pasadas y reportes.</p>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
        <form [formGroup]="filterForm" class="flex flex-col md:flex-row gap-4 items-end">

            <mat-form-field appearance="outline" class="w-full md:w-auto density-compact">
                <mat-label>Rango de Fechas</mat-label>
                <mat-date-range-input [rangePicker]="picker">
                    <input matStartDate formControlName="fechaInicio" placeholder="Inicio">
                    <input matEndDate formControlName="fechaFin" placeholder="Fin">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-full md:w-1/3 density-compact">
                <mat-label>Buscar Proveedor</mat-label>
                <input matInput formControlName="proveedor" placeholder="Nombre...">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <div class="flex gap-2 pb-1">
                <button mat-raised-button color="primary" style="background-color: #0B1E47;" (click)="aplicarFiltros()">
                    Filtrar
                </button>
                <button mat-stroked-button (click)="limpiarFiltros()">
                    Limpiar
                </button>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-semibold">
            <tr>
                <th class="p-4 text-left">ID Orden</th>
                <th class="p-4 text-left">Proveedor</th>
                <th class="p-4 text-center">Fecha Compra</th>
                <th class="p-4 text-right">Total Costo</th>
                <th class="p-4 text-center">Estado Final</th>
                <th class="p-4 text-center">Detalle</th>
            </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 text-sm">
                @for (orden of listaVisible; track orden.id) {
                    <tr class="hover:bg-gray-50 transition-colors cursor-pointer" (click)="toggleDetalle(orden)">
                        <td class="p-4 font-bold text-blue-800">{{ orden.id }}</td>
                        <td class="p-4 text-gray-700">{{ orden.proveedor }}</td>
                        <td class="p-4 text-center text-gray-500">{{ orden.fecha | date:'dd/MM/yyyy' }}</td>
                        <td class="p-4 text-right font-medium">{{ orden.totalCosto | currency }}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-xs font-bold"
                                  [class.bg-green-100]="orden.estado === 'Completado'"
                                  [class.text-green-800]="orden.estado === 'Completado'"
                                  [class.bg-red-100]="orden.estado === 'Cancelado'"
                                  [class.text-red-800]="orden.estado === 'Cancelado'"
                                  [class.bg-blue-100]="orden.estado === 'Parcial'"
                                  [class.text-blue-800]="orden.estado === 'Parcial'">
                                {{ orden.estado }}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <mat-icon class="text-gray-400 transition-transform"
                                      [class.rotate-180]="orden.expandido">
                                expand_more
                            </mat-icon>
                        </td>
                    </tr>

                    @if (orden.expandido) {
                        <tr class="bg-slate-50">
                            <td colspan="6" class="p-0">
                                <div class="p-4 pl-12 border-b border-gray-200">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Items Comprados</h4>
                                    <table class="w-full text-xs">
                                        <thead>
                                        <tr class="text-gray-400 border-b border-gray-200">
                                            <th class="pb-1 text-left">Producto</th>
                                            <th class="pb-1 text-center">Cantidad</th>
                                            <th class="pb-1 text-right">Costo Unitario (Est.)</th>
                                            <th class="pb-1 text-right">Subtotal</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            @for (item of orden.items; track item.nombre) {
                                                <tr class="border-b border-gray-100 last:border-0">
                                                    <td class="py-2 font-medium text-gray-700">{{ item.nombre }}</td>
                                                    <td class="py-2 text-center">{{ item.cantidad }}</td>
                                                    <td class="py-2 text-right">{{ (item.costo / item.cantidad) | currency }}</td>
                                                    <td class="py-2 text-right font-bold">{{ item.costo | currency }}</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    }
                }
                @if (listaVisible.length === 0) {
                    <tr>
                        <td colspan="6" class="p-8 text-center text-gray-400">
                            No se encontraron registros con esos filtros.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
