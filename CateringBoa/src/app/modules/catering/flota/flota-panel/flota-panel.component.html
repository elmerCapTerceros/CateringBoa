<div class="flex flex-col w-full min-h-screen bg-gray-50/50 p-6 sm:p-10 gap-8">

    <div>
        <h2 class="text-3xl font-bold tracking-tight text-slate-800">Gestión de Flota</h2>
        <p class="text-secondary">Seleccione paso a paso para desbloquear el abastecimiento.</p>
    </div>

    <div class="relative">
        <h3 class="flex items-center text-sm font-bold uppercase text-blue-900 mb-3 tracking-wider gap-2">
            <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
            Seleccionar Flota
        </h3>

        <div class="flex flex-wrap gap-4">
            @for (flota of flotas; track flota.id) {
                <div
                    (click)="seleccionarFlota(flota)"
                    class="cursor-pointer border-2 rounded-2xl p-6 w-40 h-36 flex flex-col items-center justify-center gap-3 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 bg-white relative overflow-hidden"
                    [ngClass]="flotaSeleccionada?.id === flota.id ? 'border-blue-600 ring-4 ring-blue-100' : 'border-gray-200 hover:border-blue-300'">

                    <mat-icon class="absolute -right-4 -bottom-4 text-gray-100" style="font-size: 80px; width: 80px; height: 80px;">{{ flota.icon }}</mat-icon>
                    <div class="z-10 bg-blue-50 p-3 rounded-full mb-1">
                        <mat-icon class="text-blue-700 icon-size-8">{{ flota.icon }}</mat-icon>
                    </div>
                    <span class="font-bold text-slate-700 text-center leading-tight z-10">{{ flota.nombre }}</span>
                    @if (flotaSeleccionada?.id === flota.id) {
                        <div class="absolute top-2 right-2 bg-blue-600 text-white rounded-full w-5 h-5 flex items-center justify-center">
                            <mat-icon class="icon-size-3">check</mat-icon>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="relative transition-all duration-500"
         [ngClass]="{'opacity-40 grayscale pointer-events-none select-none blur-[1px]': !flotaSeleccionada}">

        <h3 class="flex items-center text-sm font-bold uppercase text-gray-500 mb-3 tracking-wider gap-2"
            [class.text-blue-900]="flotaSeleccionada">
            <span class="bg-gray-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs transition-colors"
                  [class.bg-blue-600]="flotaSeleccionada">2</span>
            Seleccionar Aeronave
        </h3>

        <div class="flex flex-wrap gap-4 min-h-[100px]">
            @for (avion of aeronavesVisibles; track avion.id) {
                <div
                    (click)="seleccionarAeronave(avion)"
                    class="cursor-pointer border rounded-xl p-4 w-[160px] flex flex-col items-start bg-white transition-all hover:border-blue-400 hover:shadow-md"
                    [class.ring-2]="aeronaveSeleccionada?.id === avion.id"
                    [class.ring-blue-600]="aeronaveSeleccionada?.id === avion.id"
                    [class.bg-blue-50]="aeronaveSeleccionada?.id === avion.id">

                    <div class="flex justify-between w-full mb-2">
                        <mat-icon class="text-slate-400">airplanemode_active</mat-icon>
                        @if (aeronaveSeleccionada?.id === avion.id) {
                            <mat-icon class="text-blue-600 icon-size-5">check_circle</mat-icon>
                        }
                    </div>

                    <span class="text-lg font-black text-slate-800">{{ avion.matricula }}</span>
                    <span class="text-xs text-gray-500 font-medium mt-1">{{ avion.estado }}</span>
                </div>
            }
        </div>
    </div>

    <div class="relative transition-all duration-500"
         [ngClass]="{'opacity-40 grayscale pointer-events-none blur-[1px]': !aeronaveSeleccionada}">

        <h3 class="flex items-center text-sm font-bold uppercase text-gray-500 mb-3 tracking-wider gap-2"
            [class.text-blue-900]="aeronaveSeleccionada">
            <span class="bg-gray-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs transition-colors"
                  [class.bg-blue-600]="aeronaveSeleccionada">3</span>
            Itinerario Programado
        </h3>

        <div class="flex flex-col gap-3 mb-6">
            @for (ruta of rutasDisponibles; track ruta.id) {
                <div
                    (click)="seleccionarRuta(ruta)"
                    class="relative border rounded-xl p-4 cursor-pointer transition-all duration-300 flex items-center justify-between bg-white group hover:shadow-md"
                    [ngClass]="{
                        'border-blue-600 bg-blue-50 ring-1 ring-blue-600': rutaSeleccionada?.id === ruta.id,
                        'border-gray-200 opacity-60 hover:opacity-100': rutaSeleccionada && rutaSeleccionada?.id !== ruta.id
                    }">

                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-full bg-gray-100 group-hover:bg-white transition-colors"
                             [class.bg-blue-100]="rutaSeleccionada?.id === ruta.id">
                            <mat-icon [class.text-blue-700]="rutaSeleccionada?.id === ruta.id" class="text-gray-500">alt_route</mat-icon>
                        </div>
                        <div>
                            <div class="font-bold text-slate-800 text-lg">{{ ruta.codigo }}</div>
                            <div class="text-sm text-gray-500">{{ ruta.descripcion }}</div>
                        </div>
                    </div>

                    <div class="text-right">
                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">Distancia</div>
                        <div class="font-mono text-slate-700">{{ ruta.totalMillas }} mi</div>
                    </div>
                </div>
            }
        </div>

        @if (rutaSeleccionada) {
            <div @slideIn class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm overflow-x-auto mt-4">
                <div class="flex items-start min-w-max relative pb-4 pt-2 px-2">
                    <div class="absolute top-10 left-0 w-full h-1 bg-gray-100 -z-0"></div>

                    @for (tramo of rutaSeleccionada.tramos; track tramo.id; let last = $last) {
                        <div class="relative flex flex-col items-center group mr-12 z-10">

                            <div
                                (click)="seleccionarTramo(tramo)"
                                class="cursor-pointer w-44 border-2 bg-white rounded-xl p-4 transition-all duration-200 hover:-translate-y-1 hover:shadow-lg"
                                [class.border-blue-600]="tramoSeleccionado?.id === tramo.id"
                                [class.bg-blue-50]="tramoSeleccionado?.id === tramo.id"
                                [class.border-gray-300]="tramoSeleccionado?.id !== tramo.id">

                                <div class="flex justify-between items-center mb-3">
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-600">
                                        {{ tramo.vuelo }}
                                    </span>
                                    <span class="text-xs font-mono text-gray-500">{{ tramo.horaSalida }}</span>
                                </div>

                                <div class="flex items-center justify-between text-xl font-black text-slate-800 mb-2">
                                    <span>{{ tramo.origen }}</span>
                                    <mat-icon class="icon-size-5 text-gray-300">arrow_right_alt</mat-icon>
                                    <span>{{ tramo.destino }}</span>
                                </div>

                                <div class="h-1 w-full rounded-full transition-colors"
                                     [class.bg-blue-500]="tramoSeleccionado?.id === tramo.id"
                                     [class.bg-gray-200]="tramoSeleccionado?.id !== tramo.id"></div>
                            </div>

                            @if (!last) {
                                <div class="absolute -right-10 top-10 transform -translate-y-1/2 text-gray-300">
                                    <mat-icon>chevron_right</mat-icon>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <div class="relative transition-all duration-500"
         [ngClass]="{'opacity-40 pointer-events-none blur-[2px]': !tramoSeleccionado}">

        <h3 class="flex items-center text-sm font-bold uppercase text-gray-500 mb-3 tracking-wider gap-2"
            [class.text-blue-900]="tramoSeleccionado">
            <span class="bg-gray-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs transition-colors"
                  [class.bg-blue-600]="tramoSeleccionado">4</span>
            Gestionar Abastecimiento
        </h3>

        <div class="bg-slate-900 rounded-3xl p-6 sm:p-8 shadow-2xl border border-slate-700 min-h-[300px]">

            @if (tramoSeleccionado) {
                <div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b border-slate-700 pb-6 gap-4">
                    <div class="text-white">
                        <div class="text-sm text-slate-400 mb-1">Carga para vuelo {{ tramoSeleccionado.vuelo }}</div>
                        <div class="text-3xl font-bold">
                            {{ tramoSeleccionado.origen }} <span class="text-slate-500">➔</span> {{ tramoSeleccionado.destino }}
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button (click)="toggleSeleccionarTodo(!todosSeleccionados)"
                                class="text-sm font-medium text-slate-300 hover:text-white flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-800 transition-colors">
                            <mat-icon [class.text-blue-400]="todosSeleccionados">
                                {{ todosSeleccionados ? 'check_box' : 'check_box_outline_blank' }}
                            </mat-icon>
                            Seleccionar Todo
                        </button>
                        <div class="px-4 py-2 bg-slate-800 rounded-lg border border-slate-700">
                            <span class="text-2xl font-bold text-blue-400">{{ getTotalItems(tramoSeleccionado.itemsCatering) }}</span>
                            <span class="text-xs text-slate-400 ml-1 uppercase">Items</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    @for (item of tramoSeleccionado.itemsCatering; track item.nombre) {

                        <div
                            (click)="item.check = !item.check"
                            class="relative cursor-pointer rounded-xl p-4 border-2 transition-all duration-200 select-none group flex flex-col justify-between h-32"
                            [ngClass]="{
                                'bg-white border-gray-200 hover:border-blue-300': !item.check,
                                'bg-blue-50 border-blue-600 shadow-[0_0_15px_rgba(37,99,235,0.3)] transform scale-[1.02]': item.check
                            }">

                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold uppercase tracking-wider mb-1"
                                      [ngClass]="item.check ? 'text-blue-600' : 'text-gray-400'">
                                    {{ item.unidad }}
                                </span>

                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors"
                                     [ngClass]="item.check ? 'bg-blue-600 border-blue-600' : 'border-gray-300 bg-gray-50'">
                                    @if (item.check) { <mat-icon class="icon-size-4 text-white font-bold">check</mat-icon> }
                                </div>
                            </div>

                            <div>
                                <div class="text-3xl font-black leading-none mb-1"
                                     [ngClass]="item.check ? 'text-slate-900' : 'text-slate-700'">
                                    {{ item.cantidad }}
                                </div>
                                <div class="text-sm font-medium leading-tight line-clamp-2"
                                     [ngClass]="item.check ? 'text-blue-900 font-bold' : 'text-gray-500'">
                                    {{ item.nombre }}
                                </div>
                            </div>

                        </div>
                    }
                </div>
            } @else {
                <div class="h-full flex flex-col items-center justify-center text-slate-600 gap-4 opacity-30 py-12">
                    <mat-icon style="width: 64px; height: 64px; font-size: 64px;">shopping_cart</mat-icon>
                    <span class="text-lg font-medium">Seleccione un tramo de la ruta...</span>
                </div>
            }
        </div>
    </div>
</div>
