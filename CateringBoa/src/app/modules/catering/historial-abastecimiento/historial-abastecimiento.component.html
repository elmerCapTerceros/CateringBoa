<div class="w-full flex-auto p-6 sm:p-10 bg-gray-50 min-h-screen">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold tracking-tight text-blue-900">Historial de Abastecimiento</h2>
            <p class="text-gray-500">Auditoría de cargas realizadas por vuelo.</p>
        </div>

        <button mat-raised-button
                color="primary"
                style="background-color: #0B1E47;"
                (click)="irANuevoAbastecimiento()">
            <mat-icon class="mr-2">add_circle</mat-icon>
            Nuevo Abastecimiento
        </button>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex gap-4">
        <mat-form-field appearance="outline" class="w-full md:w-1/3 density-compact" subscriptSizing="dynamic">
            <mat-label>Buscar por Matrícula</mat-label>
            <input matInput placeholder="Ej. CP-2550">
            <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full md:w-1/3 density-compact" subscriptSizing="dynamic">
            <mat-label>Fecha de Vuelo</mat-label>
            <input matInput [matDatepicker]="picker" placeholder="dd/mm/aaaa">
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <button mat-stroked-button color="primary" class="h-[42px]">Filtrar</button>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-semibold">
            <tr>
                <th class="p-4">Aeronave / Destino</th>
                <th class="p-4 text-center">Fecha y Hora</th>
                <th class="p-4">Plantilla Usada</th>
                <th class="p-4">Responsable</th>
                <th class="p-4 text-center">Total Ítems</th>
                <th class="p-4 text-right">Detalle</th>
            </tr>
            </thead>
            <tbody class="text-sm text-gray-700">
                @for (row of historial; track row.id) {
                    <tr class="hover:bg-blue-50 transition-colors border-b border-gray-100 cursor-pointer"
                        (click)="toggleDetalle(row)"
                        [class.bg-blue-50]="row.expandido">

                        <td class="p-4">
                            <div class="font-bold text-blue-900">{{ row.vuelo }}</div>
                            <div class="text-xs text-gray-500">{{ row.destino }}</div>
                        </td>
                        <td class="p-4 text-center">{{ row.fecha }}</td>
                        <td class="p-4">
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs border border-gray-200">
                                {{ row.plantilla }}
                            </span>
                        </td>
                        <td class="p-4">{{ row.usuario }}</td>
                        <td class="p-4 text-center font-bold">{{ row.totalItems }}</td>
                        <td class="p-4 text-right">
                            <mat-icon class="text-gray-400 transition-transform duration-200"
                                      [class.rotate-180]="row.expandido">
                                expand_more
                            </mat-icon>
                        </td>
                    </tr>

                    <tr *ngIf="row.expandido" [@detailExpand]="row.expandido ? 'expanded' : 'collapsed'" class="bg-slate-50">
                        <td colspan="6" class="p-0 border-b border-gray-200">
                            <div class="p-6 pl-12">
                                <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2">
                                    <mat-icon class="icon-size-4">inventory_2</mat-icon>
                                    Manifiesto de Carga
                                </h4>

                                <div class="border rounded-lg bg-white overflow-hidden shadow-sm max-w-3xl">
                                    <table class="w-full text-xs">
                                        <thead class="bg-gray-50 border-b border-gray-200 text-gray-500">
                                        <tr>
                                            <th class="py-2 px-4 text-left">Ítem</th>
                                            <th class="py-2 px-4 text-center">Cantidad</th>
                                            <th class="py-2 px-4 text-center">Unidad</th>
                                            <th class="py-2 px-4 text-center">Tipo Carga</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            @for (item of row.detalle; track item.nombre) {
                                                <tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50">
                                                    <td class="py-2 px-4 font-medium text-gray-800">{{ item.nombre }}</td>
                                                    <td class="py-2 px-4 text-center font-bold text-blue-700">{{ item.cantidad }}</td>
                                                    <td class="py-2 px-4 text-center text-gray-500">{{ item.unidad }}</td>
                                                    <td class="py-2 px-4 text-center">
                                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold"
                                                              [class.bg-green-100]="item.tipo === 'Base'"
                                                              [class.text-green-800]="item.tipo === 'Base'"
                                                              [class.bg-orange-100]="item.tipo === 'Extra'"
                                                              [class.text-orange-800]="item.tipo === 'Extra'">
                                                            {{ item.tipo }}
                                                        </span>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-3 text-right">
                                    <button mat-button color="primary" class="text-xs">
                                        <mat-icon class="icon-size-4 mr-1">print</mat-icon>
                                        Imprimir Manifiesto
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
