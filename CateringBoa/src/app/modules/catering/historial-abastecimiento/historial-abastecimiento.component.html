<div class="flex flex-col w-full min-h-screen bg-gray-50/50 p-6 sm:p-10 gap-8">

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 class="text-3xl font-bold tracking-tight text-slate-800">Historial de Operaciones</h2>
            <p class="text-secondary">Registro histórico de abastecimiento y despachos de vuelo.</p>
        </div>
        <button mat-stroked-button color="primary" (click)="exportarReporte()">
            <mat-icon class="mr-2">download</mat-icon> Exportar Reporte
        </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between">
            <div>
                <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Vuelos Registrados</div>
                <div class="text-3xl font-black text-slate-800 mt-1">{{ kpiVuelosTotal }}</div>
            </div>
            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center">
                <mat-icon>flight</mat-icon>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between">
            <div>
                <div class="text-gray-500 text-xs font-bold uppercase tracking-wider">Unidades Despachadas</div>
                <div class="text-3xl font-black text-slate-800 mt-1">{{ kpiItemsCargados | number }}</div>
            </div>
            <div class="w-12 h-12 bg-green-50 text-green-600 rounded-full flex items-center justify-center">
                <mat-icon>inventory_2</mat-icon>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">

        <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex flex-col md:flex-row gap-4 items-center">
            <div class="relative w-full md:w-80">
                <mat-icon class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">search</mat-icon>
                <input type="text" (keyup)="aplicarFiltroTexto($event)"
                       placeholder="Buscar por vuelo, matrícula..."
                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
            </div>

            <mat-form-field appearance="outline" class="w-full md:w-64 subscript-wrapper-none">
                <mat-label>Rango de Fechas</mat-label>
                <mat-date-range-input [rangePicker]="picker">
                    <input matStartDate placeholder="Inicio" [(ngModel)]="fechaInicio">
                    <input matEndDate placeholder="Fin" [(ngModel)]="fechaFin" (dateChange)="aplicarFiltroFecha()">
                </mat-date-range-input>
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-date-range-picker #picker></mat-date-range-picker>
            </mat-form-field>

            <button mat-icon-button matTooltip="Limpiar filtros" (click)="limpiarFechas()" *ngIf="fechaInicio">
                <mat-icon>filter_alt_off</mat-icon>
            </button>
        </div>

        <div class="overflow-x-auto">
            <table mat-table [dataSource]="dataSource" matSort class="w-full">

                <ng-container matColumnDef="fecha">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="uppercase text-xs font-bold text-gray-500 bg-gray-50">Fecha</th>
                    <td mat-cell *matCellDef="let row" class="text-sm text-gray-600 font-medium">
                        {{ row.fecha | date:'dd/MM/yyyy HH:mm' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="vuelo">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="uppercase text-xs font-bold text-gray-500 bg-gray-50">Vuelo</th>
                    <td mat-cell *matCellDef="let row" class="font-bold text-slate-800">
                        {{ row.codigoVuelo }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="ruta">
                    <th mat-header-cell *matHeaderCellDef class="uppercase text-xs font-bold text-gray-500 bg-gray-50">Ruta</th>
                    <td mat-cell *matCellDef="let row">
                        <div class="flex items-center text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded w-fit font-bold">
                            {{ row.ruta }}
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="matricula">
                    <th mat-header-cell *matHeaderCellDef class="uppercase text-xs font-bold text-gray-500 bg-gray-50">Avión</th>
                    <td mat-cell *matCellDef="let row" class="text-sm text-gray-500">
                        {{ row.matricula }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="items">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="uppercase text-xs font-bold text-gray-500 bg-gray-50 text-center">Tipos Items</th>
                    <td mat-cell *matCellDef="let row" class="text-center font-mono font-bold text-slate-700">
                        {{ row.totalItems }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="responsable">
                    <th mat-header-cell *matHeaderCellDef class="uppercase text-xs font-bold text-gray-500 bg-gray-50">Despachador</th>
                    <td mat-cell *matCellDef="let row">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-[10px] font-bold text-gray-600">
                                {{ row.responsable.charAt(0) }}
                            </div>
                            <span class="text-sm text-gray-600">{{ row.responsable }}</span>
                        </div>
                    </td>
                </ng-container>

                <ng-container matColumnDef="estado">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header class="uppercase text-xs font-bold text-gray-500 bg-gray-50 text-center">Estado</th>
                    <td mat-cell *matCellDef="let row" class="text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider"
                              [ngClass]="getEstadoClass(row.estado)">
                            {{ row.estado }}
                        </span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="acciones">
                    <th mat-header-cell *matHeaderCellDef class="bg-gray-50"></th>
                    <td mat-cell *matCellDef="let row" class="text-right">
                        <button mat-icon-button color="primary" (click)="verDetalle(row)" matTooltip="Ver Detalle de Carga">
                            <mat-icon>visibility</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50 transition-colors border-b border-gray-100"></tr>
            </table>
        </div>

        <mat-paginator [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons class="border-t border-gray-200"></mat-paginator>
    </div>
</div>

<ng-template #modalDetalle>
    <div class="flex flex-col h-full bg-white" *ngIf="registroSeleccionado">

        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <div>
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <mat-icon class="text-blue-600">receipt_long</mat-icon> Detalle de Carga
                </h2>
                <p class="text-xs text-gray-500 mt-1">ID Operación: #{{ registroSeleccionado.id }}</p>
            </div>
            <button mat-icon-button (click)="dialog.closeAll()"><mat-icon>close</mat-icon></button>
        </div>

        <div class="p-6 grid grid-cols-2 gap-4 bg-white">
            <div class="flex flex-col gap-1">
                <span class="text-xs font-bold text-gray-400 uppercase">Vuelo</span>
                <span class="text-lg font-black text-slate-800">{{ registroSeleccionado.codigoVuelo }}</span>
                <span class="text-sm text-gray-500">{{ registroSeleccionado.ruta }}</span>
            </div>
            <div class="flex flex-col gap-1 text-right">
                <span class="text-xs font-bold text-gray-400 uppercase">Fecha Despacho</span>
                <span class="text-sm font-bold text-slate-700">{{ registroSeleccionado.fecha | date:'medium' }}</span>
                <span class="text-xs text-gray-500">Matrícula: {{ registroSeleccionado.matricula }}</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-6">
            <div class="border rounded-lg overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-600 font-bold uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Ítem</th>
                        <th class="px-4 py-3 text-right">Cantidad</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        @for (item of registroSeleccionado.detalles; track item.nombre) {
                            <tr>
                                <td class="px-4 py-3 font-medium text-slate-700">
                                    {{ item.nombre }} <span class="text-gray-400 font-normal text-xs">({{ item.unidad }})</span>
                                </td>
                                <td class="px-4 py-3 text-right font-bold text-slate-800">
                                    {{ item.cantidad }}
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end">
            <button mat-flat-button color="primary" (click)="dialog.closeAll()">Cerrar</button>
        </div>
    </div>
</ng-template>
