// --------------------------------------------------------
// CONFIGURACIÓN GENERAL
// --------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// 1. USUARIOS Y AUTH
// --------------------------------------------------------

enum Role {
  admin
  user
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  password      String
  role          Role      @default(user)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  abastecimientos Abastecimiento[]
  solicitudes     Solicitud[]
  solicitudesDot  SolicitudDotacion[]
  ordenesCompra   OrdenCompra[]       @relation("UsuarioCreoOrden")
}

model Customer {
  id   String @id @default(uuid())
  name String
}

// --------------------------------------------------------
// 2. FLOTA Y RUTAS
// --------------------------------------------------------

model Flota {
  idFlota     Int        @id @default(autoincrement())
  nombreFlota String     @map("Nombre_flota") @db.VarChar(45)
  descripcion String     @db.VarChar(45)
  aeronaves   Aeronave[]
}

model Aeronave {
  idAeronave   Int    @id @default(autoincrement())
  matricula    String @db.VarChar(45)
  tipoAeronave String @map("tipo_aeronave") @db.VarChar(45)
  flotaId      Int    @map("Flota_idFlota")

  flota Flota @relation(fields: [flotaId], references: [idFlota])

  // Relaciones Operativas
  abastecimientos Abastecimiento[]
  rutas           AeronaveHasRuta[]
  solicitudesDot  SolicitudDotacion[]
  cargas          Carga[]
}

model Ruta {
  idRuta    Int               @id @default(autoincrement())
  origen    String            @db.VarChar(45)
  destino   String            @db.VarChar(45)
  codigo    String?
  aeronaves AeronaveHasRuta[]
}

model AeronaveHasRuta {
  aeronaveId Int @map("Aeronave_idAeronave")
  rutaId     Int @map("Ruta_idRuta")

  aeronave Aeronave @relation(fields: [aeronaveId], references: [idAeronave])
  ruta     Ruta     @relation(fields: [rutaId], references: [idRuta])

  @@id([aeronaveId, rutaId])
}

// --------------------------------------------------------
// 3. ALMACÉN E ITEMS (CORE)
// --------------------------------------------------------

model Almacen {
  idAlmacen     Int    @id @default(autoincrement())
  nombreAlmacen String @map("nombre_almacer") @db.VarChar(45)
  tipoAlmacen   String @map("tipo_almacen") @db.VarChar(45)
  ubicacion     String @db.VarChar(45)
  codigo        String @db.VarChar(45)

  stocks          Stock[]
  abastecimientos Abastecimiento[]

  solicitudesOrigen  Solicitud[]         @relation("AlmacenSolicitante")
  solicitudesDestino Solicitud[]         @relation("AlmacenSolicitado")
  solicitudesDot     SolicitudDotacion[]
  ordenesCompra      OrdenCompra[]
}

model Stock {
  idStock   Int @id @default(autoincrement())
  almacenId Int @map("Almacen_idAlmacen")

  almacen Almacen @relation(fields: [almacenId], references: [idAlmacen])

  detallesStock DetalleStock[]
}

model Item {
  idItem        Int     @id @default(autoincrement())
  nombreItem    String  @map("nombre_item") @db.VarChar(45)
  tipoItem      String  @map("tipo_item") @db.VarChar(45)
  categoriaItem String  @map("categoria_item") @db.VarChar(45)
  unidadMedida  String? @default("Unidad")

  // --- CAMPO CRÍTICO PARA EL DESPACHO ---
  stockActual Int @default(0)

  // Relaciones Inversas (Necesarias para Prisma)
  detallesAbastecimiento DetalleAbastecimiento[]
  detallesPlantilla      DetallePlantilla[]
  detallesSolicitud      DetalleSolicitud[]
  detallesCarga          DetalleCarga[]
  detallesStock          DetalleStock[]
  detallesOrden          DetalleOrdenCompra[]
  recepcionItems         RecepcionItem[]
  detallesDotacion       DetalleDotacion[]
}

model DetalleStock {
  idDetalleStock Int @id @default(autoincrement()) @map("idDetalle_Stock")
  stockId        Int @map("Stock_idStock")
  itemId         Int @map("Item_idItem")
  cantidad       Int
  // fechaVencimiento DateTime?

  stock Stock @relation(fields: [stockId], references: [idStock])
  item  Item  @relation(fields: [itemId], references: [idItem])
}

// --------------------------------------------------------
// 4. MÓDULO DE ABASTECIMIENTO (DESPACHO)
// --------------------------------------------------------
model Abastecimiento {
  idAbastecimiento Int @id @default(autoincrement())

  codigoVuelo   String   @db.VarChar(45)
  fechaDespacho DateTime @default(now())
  estado        String   @default("DESPACHADO") @db.VarChar(20)
  observaciones String?  @db.Text

  // Relaciones
  usuarioId String
  usuario   User   @relation(fields: [usuarioId], references: [id])

  almacenId Int
  almacen   Almacen @relation(fields: [almacenId], references: [idAlmacen])

  aeronaveId Int
  aeronave   Aeronave @relation(fields: [aeronaveId], references: [idAeronave])

  detalles DetalleAbastecimiento[]

  // Historial: Un abastecimiento puede generar una Carga (Manifiesto)
  cargasGeneradas Carga[]
}

model DetalleAbastecimiento {
  idDetalle Int @id @default(autoincrement())

  abastecimientoId Int
  abastecimiento   Abastecimiento @relation(fields: [abastecimientoId], references: [idAbastecimiento], onDelete: Cascade)

  itemId Int
  item   Item @relation(fields: [itemId], references: [idItem])

  cantidad Int
}

// --------------------------------------------------------
// 5. MÓDULO DE PLANTILLAS (CONFIGURACIÓN)
// --------------------------------------------------------

model Plantilla {
  id                Int      @id @default(autoincrement())
  nombre            String
  flotaObjetivo     String   @db.VarChar(100)
  tipoVuelo         String
  fechaModificacion DateTime @updatedAt

  items DetallePlantilla[]
}

model DetallePlantilla {
  id          Int @id @default(autoincrement())
  plantillaId Int
  itemId      Int
  cantidad    Int

  plantilla Plantilla @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [idItem])
}

// --------------------------------------------------------
// 6. COMPRAS
// --------------------------------------------------------

model OrdenCompra {
  idOrdenCompra  Int       @id @default(autoincrement())
  codigoOrden    String    @unique
  proveedor      String    @db.VarChar(100)
  fechaSolicitud DateTime  @default(now()) @db.Date
  fechaEntrega   DateTime? @db.Date
  estado         String    @default("Pendiente") @db.VarChar(20)

  costoTotalEstimado Float   @default(0)
  costoTotalReal     Float   @default(0)
  observaciones      String? @db.Text

  almacenDestinoId Int
  almacenDestino   Almacen @relation(fields: [almacenDestinoId], references: [idAlmacen])

  usuarioId String
  usuario   User   @relation("UsuarioCreoOrden", fields: [usuarioId], references: [id])

  detalles    DetalleOrdenCompra[]
  recepciones Recepcion[]
}

model DetalleOrdenCompra {
  idDetalle          Int   @id @default(autoincrement())
  ordenCompraId      Int
  itemId             Int
  cantidadSolicitada Int
  cantidadRecibida   Int   @default(0)
  costoUnitario      Float

  orden OrdenCompra @relation(fields: [ordenCompraId], references: [idOrdenCompra], onDelete: Cascade)
  item  Item        @relation(fields: [itemId], references: [idItem])
}

model Recepcion {
  idRecepcion    Int      @id @default(autoincrement())
  ordenCompraId  Int
  fechaRecepcion DateTime @default(now())
  usuarioRecibio String?
  observaciones  String?

  orden OrdenCompra     @relation(fields: [ordenCompraId], references: [idOrdenCompra])
  items RecepcionItem[]
}

model RecepcionItem {
  id               Int @id @default(autoincrement())
  recepcionId      Int
  itemId           Int // Faltaba vincularlo con Item
  cantidadRecibida Int

  recepcion Recepcion @relation(fields: [recepcionId], references: [idRecepcion], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [idItem])
}

// --------------------------------------------------------
// 7. OPERACIONES (CARGA / SOLICITUDES)
// --------------------------------------------------------

model Carga {
  idCarga Int @id @default(autoincrement())

  abastecimientoId Int?
  abastecimiento   Abastecimiento? @relation(fields: [abastecimientoId], references: [idAbastecimiento])

  aeronaveId Int
  aeronave   Aeronave @relation(fields: [aeronaveId], references: [idAeronave])

  detalles        DetalleCarga[]
  configuraciones Configuracion[]
}

model DetalleCarga {
  idDetalleCarga Int @id @default(autoincrement())
  cargaId        Int
  itemId         Int
  cantidad       Int

  carga Carga @relation(fields: [cargaId], references: [idCarga])
  item  Item  @relation(fields: [itemId], references: [idItem])

  controlesConsumo ControlConsumo[]
  remanentes       Remanente[]
}

model Solicitud {
  idSolicitud          Int      @id @default(autoincrement())
  usuarioId            String
  descripcion          String   @db.VarChar(45)
  fecha                DateTime @db.Date
  prioridad            String   @db.VarChar(45)
  estado               String   @map("Estado") @db.VarChar(45)
  almacenSolicitanteId Int
  almacenSolicitadoId  Int

  usuario            User    @relation(fields: [usuarioId], references: [id])
  almacenSolicitante Almacen @relation("AlmacenSolicitante", fields: [almacenSolicitanteId], references: [idAlmacen])
  almacenSolicitado  Almacen @relation("AlmacenSolicitado", fields: [almacenSolicitadoId], references: [idAlmacen])

  detalles DetalleSolicitud[]
}

model DetalleSolicitud {
  idDetalleSolicitud Int @id @default(autoincrement())
  itemId             Int
  solicitudId        Int
  cantidad           Int

  item      Item      @relation(fields: [itemId], references: [idItem])
  solicitud Solicitud @relation(fields: [solicitudId], references: [idSolicitud])
}

model ControlConsumo {
  idControlConsumo Int    @id @default(autoincrement())
  estado           String @db.VarChar(45)
  detalleCargaId   Int
  cantidad         Int

  detalleCarga DetalleCarga @relation(fields: [detalleCargaId], references: [idDetalleCarga])
}

model Remanente {
  idRemanente    Int  @id @default(autoincrement())
  cantidad       Int?
  detalleCargaId Int

  detalleCarga DetalleCarga @relation(fields: [detalleCargaId], references: [idDetalleCarga])
}

model Configuracion {
  confiId Int @id @default(autoincrement())
  cargaId Int

  carga Carga @relation(fields: [cargaId], references: [idCarga])
}

model SolicitudDotacion {
  idSolicitudDotacion Int      @id @default(autoincrement())
  fecha               DateTime @db.Date
  estado              String   @db.VarChar(45)
  descripcion         String   @db.VarChar(45)
  almacenId           Int
  usuarioId           String
  aeronaveId          Int

  almacen  Almacen  @relation(fields: [almacenId], references: [idAlmacen])
  usuario  User     @relation(fields: [usuarioId], references: [id])
  aeronave Aeronave @relation(fields: [aeronaveId], references: [idAeronave])

  detalles DetalleDotacion[]
}

model DetalleDotacion {
  idDetalleDotacion   Int @id @default(autoincrement())
  cantidad            Int
  itemId              Int // Faltaba esto
  solicitudDotacionId Int

  solicitud SolicitudDotacion @relation(fields: [solicitudDotacionId], references: [idSolicitudDotacion])
  item      Item              @relation(fields: [itemId], references: [idItem])
}
