// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// ... (GENERATOR & DATASOURCE remain the same) ...

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  user
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified DateTime?
  password      String
  role          Role      @default(user)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  Abastecimiento    Abastecimiento[]
  Solicitud         Solicitud[]
  SolicitudDotacion SolicitudDotacion[]
  OrdenesCompra     OrdenCompra[]       @relation("UsuarioCreoOrden") // New
}

model Customer {
  id   String @id @default(uuid())
  name String
}

// --------------------------------------------------------
// 2. FLEET & ALMACEN
// --------------------------------------------------------

model Flota {
  idFlota     Int        @id @default(autoincrement())
  nombreFlota String     @map("Nombre_flota") @db.VarChar(45)
  descripcion String     @db.VarChar(45)
  aeronaves   Aeronave[]
}

model Aeronave {
  idAeronave   Int    @id @default(autoincrement())
  matricula    String @db.VarChar(45)
  tipoAeronave String @map("tipo_aeronave") @db.VarChar(45)
  flotaId      Int    @map("Flota_idFlota")

  flota Flota @relation(fields: [flotaId], references: [idFlota])

  cargas         Carga[]
  rutas          AeronaveHasRuta[]
  solicitudesDot SolicitudDotacion[]
  detallesCarga  DetalleCarga[]
}

model Almacen {
  idAlmacen     Int    @id @default(autoincrement())
  nombreAlmacen String @map("nombre_almacer") @db.VarChar(45)
  tipoAlmacen   String @map("tipo_almacen") @db.VarChar(45)
  ubicacion     String @db.VarChar(45)
  codigo        String @db.VarChar(45)

  stocks             Stock[]
  solicitudesOrigen  Solicitud[]         @relation("AlmacenSolicitante")
  solicitudesDestino Solicitud[]         @relation("AlmacenSolicitado")
  solicitudesDot     SolicitudDotacion[]

  // Relations for Purchases
  ordenesCompra OrdenCompra[]
}

model Stock {
  idStock   Int @id @default(autoincrement())
  almacenId Int @map("Almacen_idAlmacen")

  almacen Almacen @relation(fields: [almacenId], references: [idAlmacen])

  abastecimientos Abastecimiento[]
  detallesStock   DetalleStock[]
  // entregas removed from here, logic moved to Recepcion
}

model Item {
  idItem        Int     @id @default(autoincrement())
  nombreItem    String  @map("nombre_item") @db.VarChar(45)
  tipoItem      String  @map("tipo_item") @db.VarChar(45)
  categoriaItem String  @map("categoria_item") @db.VarChar(45)
  unidadMedida  String? @default("Unidad") // Added for frontend display

  // Relaciones
  abastecimientos   Abastecimiento[]
  detallesSolicitud DetalleSolicitud[]
  detallesCarga     DetalleCarga[]
  detallesStock     DetalleStock[]
  detallesPlantilla DetallePlantilla[]

  // New Relation for Purchase Details
  detallesOrden DetalleOrdenCompra[]
}

// --------------------------------------------------------
// 3. OPERACIONES (ABASTECIMIENTO, CARGA, SOLICITUDES)
// --------------------------------------------------------
// ... (This section remains mostly the same, abbreviated for clarity) ...

model Abastecimiento {
  idAbastecimiento Int      @default(autoincrement())
  stockId          Int      @map("Stock_idStock")
  itemId           Int      @map("Item_idItem")
  fecha            DateTime @db.Date
  usuarioId        String   @map("Usuario_idUsuario")
  clase            String   @db.VarChar(45)

  stock   Stock @relation(fields: [stockId], references: [idStock])
  item    Item  @relation(fields: [itemId], references: [idItem])
  usuario User  @relation(fields: [usuarioId], references: [id])

  cargas Carga[]

  @@id([idAbastecimiento, itemId])
}

model Carga {
  idCarga              Int @default(autoincrement())
  aeronaveId           Int @map("Aeronave_idAeronave")
  abastecimientoId     Int @map("Abastecimiento_idAbastecimiento")
  abastecimientoItemId Int @map("Abastecimiento_Item_idItem")

  aeronave       Aeronave       @relation(fields: [aeronaveId], references: [idAeronave])
  abastecimiento Abastecimiento @relation(fields: [abastecimientoId, abastecimientoItemId], references: [idAbastecimiento, itemId])

  configuraciones Configuracion[]
  detallesCarga   DetalleCarga[]

  @@id([idCarga, aeronaveId])
}

model Solicitud {
  idSolicitud          Int      @id @default(autoincrement())
  usuarioId            String   @map("Usuario_idUsuario")
  descripcion          String   @db.VarChar(45)
  fecha                DateTime @db.Date
  prioridad            String   @db.VarChar(45)
  estado               String   @map("Estado") @db.VarChar(45)
  almacenSolicitanteId Int      @map("AlmacenSolicitante_id")
  almacenSolicitadoId  Int      @map("AlmacenSolicitado_id")

  usuario            User    @relation(fields: [usuarioId], references: [id])
  almacenSolicitante Almacen @relation("AlmacenSolicitante", fields: [almacenSolicitanteId], references: [idAlmacen])
  almacenSolicitado  Almacen @relation("AlmacenSolicitado", fields: [almacenSolicitadoId], references: [idAlmacen])

  detalles DetalleSolicitud[]
}

model Ruta {
  idRuta    Int               @id @default(autoincrement())
  origen    String            @db.VarChar(45)
  destino   String            @db.VarChar(45)
  codigo    String? // Added for frontend form
  aeronaves AeronaveHasRuta[]
}

model AeronaveHasRuta {
  aeronaveId Int @map("Aeronave_idAeronave")
  rutaId     Int @map("Ruta_idRuta")

  aeronave Aeronave @relation(fields: [aeronaveId], references: [idAeronave])
  ruta     Ruta     @relation(fields: [rutaId], references: [idRuta])

  @@id([aeronaveId, rutaId])
}

// --------------------------------------------------------
// 4. MODULO DE COMPRAS (REFACTORIZADO)
// --------------------------------------------------------

model OrdenCompra {
  idOrdenCompra  Int       @id @default(autoincrement())
  codigoOrden    String    @unique // Ej: "OC-2025-001"
  proveedor      String    @db.VarChar(100)
  fechaSolicitud DateTime  @default(now()) @db.Date
  fechaEntrega   DateTime? @db.Date

  // Estados: 'Pendiente', 'Parcial', 'Completado', 'Cancelado'
  estado String @default("Pendiente") @db.VarChar(20)

  // Costos
  costoTotalEstimado Float @default(0)
  costoTotalReal     Float @default(0) // Se actualiza al recibir mercadería

  observaciones String? @db.Text

  // Relaciones
  almacenDestinoId Int
  almacenDestino   Almacen @relation(fields: [almacenDestinoId], references: [idAlmacen])

  usuarioId String
  usuario   User   @relation("UsuarioCreoOrden", fields: [usuarioId], references: [id])

  detalles    DetalleOrdenCompra[]
  recepciones Recepcion[] // Historial de camiones que llegaron
}

model DetalleOrdenCompra {
  idDetalle     Int @id @default(autoincrement())
  ordenCompraId Int
  itemId        Int

  cantidadSolicitada Int
  cantidadRecibida   Int @default(0) // Se incrementa con las recepciones

  costoUnitario Float // Costo pactado con el proveedor

  // Relaciones
  orden OrdenCompra @relation(fields: [ordenCompraId], references: [idOrdenCompra], onDelete: Cascade)
  item  Item        @relation(fields: [itemId], references: [idItem])
}

// Historial de recepciones (Cuando llega el camión)
model Recepcion {
  idRecepcion    Int      @id @default(autoincrement())
  ordenCompraId  Int
  fechaRecepcion DateTime @default(now())
  usuarioRecibio String? // Nombre o ID del usuario que dio click en "Recibir"
  observaciones  String?

  orden OrdenCompra     @relation(fields: [ordenCompraId], references: [idOrdenCompra])
  items RecepcionItem[]
}

// Detalle de qué ítems llegaron en una recepción específica
model RecepcionItem {
  id               Int @id @default(autoincrement())
  recepcionId      Int
  itemId           Int
  cantidadRecibida Int

  recepcion Recepcion @relation(fields: [recepcionId], references: [idRecepcion], onDelete: Cascade)
}

// --------------------------------------------------------
// ... (RESTO DEL ESQUEMA IGUAL: DetalleSolicitud, Carga, etc.)
// --------------------------------------------------------

model DetalleSolicitud {
  idDetalleSolicitud Int @default(autoincrement()) @map("idDetalle_solicitud")
  itemId             Int @map("Item_idItem1")
  solicitudId        Int @map("Solicitud_idSolicitud")
  cantidad           Int

  item      Item      @relation(fields: [itemId], references: [idItem])
  solicitud Solicitud @relation(fields: [solicitudId], references: [idSolicitud])

  @@id([idDetalleSolicitud, itemId, solicitudId])
}

model DetalleCarga {
  idDetalleCarga  Int @default(autoincrement()) @map("iddetalle_carga")
  itemId          Int @map("Item_idItem")
  cargaId         Int @map("Carga_idCarga")
  cargaAeronaveId Int @map("Carga_Aeronave_idAeronave")
  cantidad        Int

  item     Item     @relation(fields: [itemId], references: [idItem])
  carga    Carga    @relation(fields: [cargaId, cargaAeronaveId], references: [idCarga, aeronaveId])
  aeronave Aeronave @relation(fields: [cargaAeronaveId], references: [idAeronave])

  controlesConsumo ControlConsumo[]
  remanentes       Remanente[]

  @@id([idDetalleCarga, itemId, cargaId, cargaAeronaveId])
}

model ControlConsumo {
  idControlConsumo       Int    @id @default(autoincrement()) @map("idControl_consumo")
  estado                 String @db.VarChar(45)
  detalleCargaId         Int    @map("detalle_carga_iddetalle_carga")
  detalleCargaItemId     Int    @map("detalle_carga_Item_idItem")
  detalleCargaCargaId    Int    @map("detalle_carga_Carga_idCarga")
  detalleCargaAeronaveId Int    @map("detalle_carga_Carga_Aeronave_idAeronave")
  cantidad               Int

  detalleCarga DetalleCarga @relation(fields: [detalleCargaId, detalleCargaItemId, detalleCargaCargaId, detalleCargaAeronaveId], references: [idDetalleCarga, itemId, cargaId, cargaAeronaveId])
}

model DetalleStock {
  idDetalleStock Int @default(autoincrement()) @map("idDetalle_Stock")
  cantidad       Int
  stockId        Int @map("Stock_idStock")
  itemId         Int @map("Item_idItem")

  stock Stock @relation(fields: [stockId], references: [idStock])
  item  Item  @relation(fields: [itemId], references: [idItem])

  @@id([idDetalleStock, itemId])
}

model Remanente {
  idRemanente            Int  @id @default(autoincrement())
  cantidad               Int?
  detalleCargaId         Int  @map("detalle_carga_iddetalle_carga")
  detalleCargaItemId     Int  @map("detalle_carga_Item_idItem")
  detalleCargaCargaId    Int  @map("detalle_carga_Carga_idCarga")
  detalleCargaAeronaveId Int  @map("detalle_carga_Carga_Aeronave_idAeronave")

  detalleCarga DetalleCarga @relation(fields: [detalleCargaId, detalleCargaItemId, detalleCargaCargaId, detalleCargaAeronaveId], references: [idDetalleCarga, itemId, cargaId, cargaAeronaveId])
}

model Configuracion {
  confiId         Int @id @default(autoincrement()) @map("confi_id")
  cargaId         Int @map("Carga_idCarga")
  cargaAeronaveId Int @map("Carga_Aeronave_idAeronave")

  carga Carga @relation(fields: [cargaId, cargaAeronaveId], references: [idCarga, aeronaveId])
}

model SolicitudDotacion {
  idSolicitudDotacion Int @id @default(autoincrement()) @map("idSolicitud_Dotacion")

  fecha       DateTime @db.Date
  estado      String   @map("Estado") @db.VarChar(45)
  descripcion String   @map("Descripcion") @db.VarChar(45)
  almacenId   Int      @map("Almacen_idAlmacen")
  usuarioId   String   @map("Usuario_idUsuario")
  aeronaveId  Int      @map("Aeronave_idAeronave")

  almacen  Almacen  @relation(fields: [almacenId], references: [idAlmacen])
  usuario  User     @relation(fields: [usuarioId], references: [id])
  aeronave Aeronave @relation(fields: [aeronaveId], references: [idAeronave])

  detalles DetalleDotacion[]
}

model DetalleDotacion {
  idDetalleDotacion   Int               @default(autoincrement()) @map("idDetalle_dotacion")
  cantidad            Int
  solicitudDotacionId Int               @map("Solicitud_Dotacion_idSolicitud_Dotacion")
  solicitud           SolicitudDotacion @relation(fields: [solicitudDotacionId], references: [idSolicitudDotacion])

  @@id([idDetalleDotacion, solicitudDotacionId])
}

// 6. PLANTILLAS (Para el Módulo Configuración de Carga)

model Plantilla {
  id                 Int      @id @default(autoincrement())
  nombre             String
  modeloAeronave     String
  clase              String
  fechaCreacion      DateTime @default(now())
  ultimaModificacion DateTime @updatedAt

  items DetallePlantilla[]
}

model DetallePlantilla {
  id          Int @id @default(autoincrement())
  plantillaId Int
  itemId      Int
  cantidad    Int

  plantilla Plantilla @relation(fields: [plantillaId], references: [id], onDelete: Cascade)
  item      Item      @relation(fields: [itemId], references: [idItem])
}
