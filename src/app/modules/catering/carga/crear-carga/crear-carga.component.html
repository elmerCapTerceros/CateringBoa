<div class="flex flex-col flex-auto min-w-0">
    <div class="flex-auto p-6 sm:p-10">

        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <button
                    (click)="cancelar()"
                    class="flex items-center text-gray-600 hover:text-gray-900 mb-2">
                    <mat-icon>arrow_back</mat-icon>
                    <span class="ml-2">Volver</span>
                </button>
                <h2 class="text-3xl font-bold">Crear Nueva Carga</h2>
            </div>
        </div>

        <!-- Formulario -->
        <form [formGroup]="cargaForm" (ngSubmit)="guardarCarga()">

            <!-- Información de la Carga -->
            <mat-card class="mb-6">
                <mat-card-content>
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Información de la Carga</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Código -->
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Código de carga *</mat-label>
                            <input
                                matInput
                                formControlName="codigo"
                                placeholder="BOA-001"
                                readonly>
                            <mat-icon matSuffix>qr_code</mat-icon>
                            <mat-error *ngIf="cargaForm.get('codigo')?.hasError('required')">
                                {{ getErrorMessage('codigo') }}
                            </mat-error>
                        </mat-form-field>

                        <!-- Aeronave -->
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Aeronave *</mat-label>
                            <mat-select formControlName="aeronave">
                                <mat-option *ngFor="let aeronave of aeronaves" [value]="aeronave.value">
                                    {{ aeronave.viewValue }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>flight</mat-icon>
                            <mat-error *ngIf="cargaForm.get('aeronave')?.hasError('required')">
                                {{ getErrorMessage('aeronave') }}
                            </mat-error>
                        </mat-form-field>

                        <!-- Origen -->
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Origen *</mat-label>
                            <mat-select formControlName="origen">
                                <mat-option *ngFor="let ciudad of ciudades" [value]="ciudad.value">
                                    {{ ciudad.viewValue }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>flight_takeoff</mat-icon>
                            <mat-error *ngIf="cargaForm.get('origen')?.hasError('required')">
                                {{ getErrorMessage('origen') }}
                            </mat-error>
                        </mat-form-field>

                        <!-- Destino -->
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Destino *</mat-label>
                            <mat-select formControlName="destino">
                                <mat-option *ngFor="let ciudad of ciudades" [value]="ciudad.value">
                                    {{ ciudad.viewValue }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>flight_land</mat-icon>
                            <mat-error *ngIf="cargaForm.get('destino')?.hasError('required')">
                                {{ getErrorMessage('destino') }}
                            </mat-error>
                        </mat-form-field>

                        <!-- Tipo -->
                        <mat-form-field appearance="outline" class="w-full md:col-span-2">
                            <mat-label>Tipo de carga *</mat-label>
                            <mat-select formControlName="tipo">
                                <mat-option *ngFor="let tipo of tipos" [value]="tipo">
                                    {{ tipo }}
                                </mat-option>
                            </mat-select>
                            <mat-icon matSuffix>category</mat-icon>
                            <mat-error *ngIf="cargaForm.get('tipo')?.hasError('required')">
                                {{ getErrorMessage('tipo') }}
                            </mat-error>
                        </mat-form-field>

                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Items de la Carga -->
            <mat-card>
                <mat-card-content>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">
                            Ítems de la Carga *
                            <span class="ml-2 text-sm text-gray-500">({{ items.length }} items)</span>
                        </h3>
                        <button
                            type="button"
                            (click)="agregarItem()"
                            mat-raised-button
                            color="primary">
                            <mat-icon>add</mat-icon>
                            Agregar Item
                        </button>
                    </div>

                    <!-- Lista de Items -->
                    <div formArrayName="items" class="space-y-4">
                        <div *ngFor="let item of items.controls; let i = index"
                             [formGroupName]="i"
                             class="p-4 border border-gray-200 rounded-lg bg-gray-50">

                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-700">Item #{{ i + 1 }}</h4>
                                <button
                                    type="button"
                                    (click)="eliminarItem(i)"
                                    mat-icon-button
                                    color="warn"
                                    [disabled]="items.length === 1">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

                                <!-- Categoría -->
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Categoría</mat-label>
                                    <mat-select formControlName="categoria">
                                        <mat-option *ngFor="let cat of categorias" [value]="cat">
                                            {{ cat }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="items.at(i).get('categoria')?.hasError('required')">
                                        {{ getItemErrorMessage(i, 'categoria') }}
                                    </mat-error>
                                </mat-form-field>

                                <!-- Nombre -->
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Nombre del ítem</mat-label>
                                    <input matInput formControlName="nombre" placeholder="Ej: Agua mineral">
                                    <mat-error *ngIf="items.at(i).get('nombre')?.hasError('required')">
                                        {{ getItemErrorMessage(i, 'nombre') }}
                                    </mat-error>
                                </mat-form-field>

                                <!-- Cantidad -->
                                <mat-form-field appearance="outline" class="w-full">
                                    <mat-label>Cantidad</mat-label>
                                    <input
                                        matInput
                                        type="number"
                                        formControlName="cantidad"
                                        placeholder="0"
                                        min="1">
                                    <mat-error *ngIf="items.at(i).get('cantidad')?.hasError('required')">
                                        {{ getItemErrorMessage(i, 'cantidad') }}
                                    </mat-error>
                                    <mat-error *ngIf="items.at(i).get('cantidad')?.hasError('min')">
                                        {{ getItemErrorMessage(i, 'cantidad') }}
                                    </mat-error>
                                </mat-form-field>

                            </div>
                        </div>
                    </div>

                    <!-- Mensaje si no hay items -->
                    <div *ngIf="items.length === 0" class="text-center py-8 text-gray-500">
                        <mat-icon class="text-6xl text-gray-300">inventory_2</mat-icon>
                        <p class="mt-2">No hay ítems agregados</p>
                        <button
                            type="button"
                            (click)="agregarItem()"
                            mat-raised-button
                            color="primary"
                            class="mt-4">
                            <mat-icon>add</mat-icon>
                            Agregar primer item
                        </button>
                    </div>

                </mat-card-content>
            </mat-card>

            <!-- Botones de Acción -->
            <div class="flex justify-end gap-4 mt-6">
                <button
                    type="button"
                    (click)="cancelar()"
                    mat-stroked-button
                    color="warn"
                    [disabled]="isLoading">
                    <mat-icon>cancel</mat-icon>
                    Cancelar
                </button>

                <button
                    type="submit"
                    mat-raised-button
                    color="primary"
                    [disabled]="isLoading">
                    <mat-icon *ngIf="!isLoading">save</mat-icon>
                    <mat-spinner *ngIf="isLoading" diameter="20" class="inline-block mr-2"></mat-spinner>
                    {{ isLoading ? 'Guardando...' : 'Guardar Carga' }}
                </button>
            </div>

        </form>

    </div>
</div>
